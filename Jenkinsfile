pipeline {
    agent {
            docker {
                image 'commitlint/commitlint:latest'
                args '-v $PWD:/workspace --entrypoint=""' 
        }
    }
   environment {
        GITHUB_PAT = credentials('github_pat')
        NEXT_VERSION = nextVersion()
        PREVIOUS_VERSION = currentVersion()
        DOCKER_CREDS = credentials('dockerhub-credentials')
        DOCKER_REGISTRY = 'hsa404/webapp'
    }

    stages {
        
        // stage('Install Dependencies') {
        //     steps {
        //         sh 'apt-get install -y nodejs npm'
        //     }
        // }

        stage('Check Commit Message') {
            when{
                not{
                    branch 'main'
                
                }
            }
            steps{
                script{
                    String commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim();
                     sh """
                        if [ ! -f commitlint.config.js ]; then
                            echo "module.exports = {extends: ['@commitlint/config-conventional']};" > commitlint.config.js
                        fi
                    """

                    // Check the last commit message
                    sh "commitlint --last"
                }
                
            }
        }

       stage('Build') {
            when {
                branch 'main'
            }
            stages{
                stage('Checkout') {
                    steps {
                        git branch: 'main', url: 'https://github.com/csye7125-su24-team18/webapp-cve-processor.git', credentialsId: 'github_pat'
                    }
                }

                stage('Setup Docker Buildx') {
                    steps {
                        script {
                            // Check if a builder with the specified name already exists
                            def builderExists = sh(script: 'docker buildx inspect --bootstrap mybuilder', returnStatus: true) == 0

                            // If the builder exists, remove it
                            if (builderExists) {
                                sh 'docker buildx rm mybuilder'
                            }

                            // Create a new builder
                            sh '''
                                docker buildx create --name mybuilder --use
                                docker buildx inspect --bootstrap
                            '''
                        }
                    }
                }

                stage('Build and Push Docker Image') {
                    steps {
                        script {
                            withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                                sh '''
                                    echo "Docker Username: \$DOCKER_USERNAME"
                                    echo "Docker Password: \$DOCKER_PASSWORD"
                                    echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
                                '''
                                
                                sh '''
                                    cd webapp-cve-processor
                                    docker buildx build --platform linux/amd64,linux/arm64 -t ${DOCKER_REGISTRY}:${PREVIOUS_VERSION} --push .
                                    docker buildx rm mybuilder
                                '''
                            }
                        }
                    }
                }
            }
        }


        stage('Notify') {
            steps {
                script{
                    // def gitStatusPostUrl = "https://${GITHUB_PAT}:x-oauth-basic@api.github.com/csye7125-su24-team18/ami-jenkins/statuses/${env.GIT_COMMIT}"
                    def gitStatusPostUrl = "https://api.github.com/repos/csye7125-su24-team18/webapp-cve-processor/statuses/${env.GIT_COMMIT}"
                    def buildUrl = ""
                    sh'''
                        echo "Posting status to GitHub: ${gitStatusPostUrl}"
                        echo "Build URL: ${buildUrl}"
                    '''
                    echo "Posting status to GitHub: ${gitStatusPostUrl}"
                    echo "Build URL: ${buildUrl}"
                    def payload = """
                    {
                        "state": "success",
                        "target_url": "${buildUrl}",
                        "description": "Jenkins build passed",
                        "context": "Jenkins CI"
                    }
                    """
                    withCredentials([usernamePassword(credentialsId: 'github_pat',
                        usernameVariable: 'GIT_USER', 
                        passwordVariable: 'GIT_PASS' 
                        )]) 
                    {
                        def response = sh(
                            script: """
                                curl -X POST -u ${GIT_USER}:${GITPASS} -H "Content-Type: application/json" -d '${payload}' ${gitStatusPostUrl} -o response.txt -w '%{response_code}'
                            """,
                            returnStdout: true
                        ).trim()
                        echo "Response: ${response}"
                        if (response != "201") {
                            error "Failed to update commit status on GitHub. Response code: ${response}"
                        } else {
                            echo "Commit status updated successfully on GitHub."
                        }
                    }
                }
            }
        }

        stage ('Cleanup') {
            steps {
                echo "Cleaning up the code"
            }
        }

    
    }
}
